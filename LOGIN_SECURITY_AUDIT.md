# รายงานความปลอดภัยระบบ Login และบทบาทผู้ใช้

## สรุปผลการตรวจสอบ

### ระบบ Login พร้อมใช้งานหรือยัง?
**พร้อมใช้งาน** — มีการจัดการ error หลักครบ และมีการปรับปรุงเพิ่มเติมแล้ว

---

## 1. Login (เข้าสู่ระบบ)

### สถานการณ์ที่จัดการแล้ว

| สถานการณ์ | ข้อความที่แสดง | การจัดการ |
|-----------|----------------|----------|
| อีเมลหรือรหัสผิด | "อีเมลหรือรหัสผ่านไม่ถูกต้อง" | ใช้ `error.code === 'invalid_credentials'` และรองรับ message |
| อีเมลยังไม่ยืนยัน | "กรุณายืนยันอีเมลก่อนเข้าสู่ระบบ" | ใช้ `error.code === 'email_not_confirmed'` |
| บัญชีถูกระงับ | "บัญชีนี้ถูกระงับการใช้งาน" | ใช้ `error.code === 'user_banned'` |
| ส่งคำขอมากเกินไป | "ส่งคำขอมากเกินไป..." + countdown | Rate limit cooldown 120 วินาที |
| รูปแบบอีเมลผิด | "รูปแบบอีเมลไม่ถูกต้อง" | Validation ก่อนส่ง + error จาก Supabase |

### ความปลอดภัย
- ใช้ `error.code` เป็นหลัก (ตามคำแนะนำ Supabase)
- ป้องกัน double submit (loading state)
- Rate limit cooldown ป้องกัน brute force
- อีเมลทำ trim + lowercase ก่อนส่ง

---

## 2. Sign Up (สมัครสมาชิก)

### สถานการณ์ที่จัดการแล้ว

| สถานการณ์ | ข้อความที่แสดง | การจัดการ |
|-----------|----------------|----------|
| อีเมลซ้ำ | "อีเมลนี้ถูกใช้งานแล้ว กรุณาเข้าสู่ระบบแทน" | ใช้ error.code + ตรวจสอบ identities ว่าง |
| รหัสผ่านอ่อนแอ | "รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร..." | ใช้ `error.code === 'weak_password'` |
| รหัสผ่านไม่ตรงกัน | "รหัสผ่านไม่ตรงกัน" | Validation ใน frontend |
| รูปแบบอีเมลผิด | "รูปแบบอีเมลไม่ถูกต้อง" | Validation ก่อนส่ง |
| Rate limit | "ส่งคำขอมากเกินไป..." + countdown | Cooldown 120 วินาที |

### ความปลอดภัย
- ตรวจสอบ `identities` ว่าง = อีเมลซ้ำ (Supabase ไม่ return error เพื่อป้องกัน account enumeration)
- รหัสผ่านขั้นต่ำ 6 ตัว (ตาม Supabase default)
- ยืนยันรหัสผ่าน 2 ช่อง

---

## 3. บทบาทผู้ใช้ (User Role)

### โครงสร้างในฐานข้อมูล
- ตาราง `user_profiles` มีคอลัมน์ `role` ค่าได้: `platform_admin`, `school_admin`, `teacher`
- Default: `teacher`

### สถานะปัจจุบัน
- **ยังไม่ได้ใช้บทบาทในการควบคุมการเข้าถึง** — ผู้ใช้ทุกคนที่ login ได้จะเห็นและจัดการได้เหมือนกัน
- `ProtectedRoute` ตรวจแค่ `isAuthenticated` ไม่ได้ตรวจ `role`
- ข้อมูลใน Supabase มี RLS (Row Level Security) — แต่ละคนเห็นเฉพาะข้อมูลของตัวเอง (ตาม `user_id`)

### หมายเหตุ
- ถ้าต้องการจำกัดฟีเจอร์ตามบทบาท (เช่น เฉพาะ platform_admin เข้า Dashboard ได้) ต้องเพิ่มการตรวจ `authUser.role` ใน component ที่เกี่ยวข้อง

---

## 4. นักเรียน — ชื่อ/รหัสซ้ำ

### รหัสนักเรียน (student_id)
- **UNIQUE ต่อ user** — ในตาราง `students` มี constraint `UNIQUE(user_id, student_id)`
- **จัดการแล้ว** — เมื่อใส่รหัสซ้ำ จะแสดง "รหัสนักเรียนนี้มีอยู่ในระบบแล้ว กรุณาใช้รหัสอื่น"
- ใช้ทั้งตอนเพิ่มและตอนแก้ไขนักเรียน

### ชื่อ-นามสกุล (first_name, last_name)
- **ไม่มี constraint เป็น unique** — หลายคนใช้ชื่อซ้ำได้ (ตามการออกแบบ)
- ไม่มีการแจ้ง "ชื่อซ้ำ" เพราะไม่อนุญาตให้ซ้ำเฉพาะ `student_id`

---

## 5. RLS (Row Level Security)

- เปิด RLS ทุกตารางที่เกี่ยวข้อง
- Policy: ผู้ใช้เห็นและจัดการได้เฉพาะแถวที่ `user_id = auth.uid()`
- `user_profiles` สร้างอัตโนมัติผ่าน trigger `handle_new_user` เมื่อ sign up

---

## 6. สิ่งที่ควรพิจารณาเพิ่ม (ถ้าต้องการความปลอดภัยสูงขึ้น)

1. **รหัสผ่าน** — เพิ่มความยาวขั้นต่ำเป็น 8 ตัวหรือกำหนด password policy ที่เข้มงวดขึ้น
2. **Email verification** — เปิดใช้ใน Supabase ถ้าต้องการให้ยืนยันอีเมลก่อนใช้งาน
3. **Role-based access** — เพิ่มการตรวจ `role` ในหน้าที่ต้องการจำกัด (เช่น admin-only)
4. **CAPTCHA** — ถ้าเป็น public app ที่เสี่ยง brute force สูง
